---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

// Try English content first, fallback to French
let posts = await getCollection('blog', ({ id }) => id.startsWith('en/'));
if (posts.length === 0) {
  posts = await getCollection('blog', ({ id }) => id.startsWith('fr/'));
}

// Extract all unique tags and count occurrences
const tagCounts = new Map<string, number>();

posts.forEach((post) => {
  post.data.tags.forEach((tag) => {
    const normalizedTag = tag.toLowerCase();
    tagCounts.set(normalizedTag, (tagCounts.get(normalizedTag) || 0) + 1);
  });
});

// Sort tags by count (descending), then alphabetically
const sortedTags = Array.from(tagCounts.entries()).sort((a, b) => {
  if (b[1] !== a[1]) return b[1] - a[1];
  return a[0].localeCompare(b[0]);
});
---

<BaseLayout title="Tags - Cocoweb" description="All tags on the Cocoweb blog." lang="en">
  <div class="tags-page">
    <h1>Tags</h1>
    <p class="tags-description">
      Explore my tech watch and web discoveries by tags.
    </p>
    <p class="tags-description">
      <span class="tags-count">{sortedTags.length}</span> tags available as of now.
    </p>
    
    <ul class="tags-list">
      {sortedTags.map(([tag, count]) => (
        <li>
          <a href={`/tags/${tag.replace(/\s+/g, '-')}/`} class="tag-link">
            <span class="tag-name">#{tag}</span>
            <span class="tag-count">{count}</span>
          </a>
        </li>
      ))}
    </ul>
  </div>
</BaseLayout>


<style>
  .tags-page {
    max-width: 42rem;
    margin: 0 auto;
  }

  .tags-description {
    opacity: 0.8;
    margin-bottom: 2rem;
  }

  .tags-list {
    list-style: none;
    padding: 0;
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  .tag-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    color: light-dark(var(--flexoki-black), var(--flexoki-50));
    background: light-dark(var(--flexoki-purple-200), var(--flexoki-purple-600));
    border-radius: 4px;
    text-decoration: none;
    transition: background-color 0.2s ease;
  }

  .tag-link:hover {
    background: light-dark(var(--flexoki-purple-100), var(--flexoki-purple-400));
  }

  .tag-link:hover .tag-count {
    background: light-dark(var(--flexoki-purple-400), var(--flexoki-purple-600));
  }

  .tag-name {
    font-weight: 500;
  }

  .tag-count {
    font-size: 0.875rem;
    opacity: 0.7;
    color: light-dark(var(--flexoki-paper), var(--flexoki-paper));
    background: light-dark(var(--flexoki-purple-600), var(--flexoki-purple-800));
    padding: 0.125rem 0.5rem;
    border-radius: 999px;
  }
</style>