---
import { getCollection, type CollectionEntry } from 'astro:content';
import BaseLayout from './BaseLayout.astro';
import { getLangFromUrl, useTranslations, getLocalizedUrl, formatDate as formatDateI18n, type Lang } from '../i18n/utils';

interface Props {
  frontmatter: CollectionEntry<'blog'>['data'];
  slug: string;
  lang?: Lang;
  showTranslationNotice?: boolean;
}

const { frontmatter, slug, lang: propLang, showTranslationNotice = false } = Astro.props;
const { title, description, date, tags, ogImage } = frontmatter;

// Determine language from prop or URL
const lang = propLang || getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Get posts for the current language for prev/next navigation
const langPrefix = lang === 'en' ? 'en/' : 'fr/';
let postsForNav = await getCollection('blog', ({ id }) => id.startsWith(langPrefix));

// Fallback to French if no English posts
if (postsForNav.length === 0 && lang === 'en') {
  postsForNav = await getCollection('blog', ({ id }) => id.startsWith('fr/'));
}

const sortedPosts = postsForNav.sort((a, b) => a.data.date.valueOf() - b.data.date.valueOf());

// Find current post index (comparing without language prefix)
const slugWithoutLang = slug.replace(/^(en|fr)\//, '');
const currentIndex = sortedPosts.findIndex((post) => 
  post.slug.replace(/^(en|fr)\//, '') === slugWithoutLang
);
const previousPost = currentIndex > 0 ? sortedPosts[currentIndex - 1] : null;
const nextPost = currentIndex < sortedPosts.length - 1 ? sortedPosts[currentIndex + 1] : null;

// Format date for display using i18n
function formatDate(date: Date): string {
  return date.toLocaleDateString(lang === 'fr' ? 'fr-FR' : 'en-GB', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
}

// Format date for datetime attribute
function formatDateISO(date: Date): string {
  return date.toISOString().split('T')[0];
}

// Get localized blog path
const blogBasePath = getLocalizedUrl('/blog/', lang);
const tagsBasePath = getLocalizedUrl('/tags/', lang);
---

<BaseLayout
  title={title}
  description={description}
  ogImage={ogImage || '/img/og-tips.webp'}
  date={date}
  type="article"
  tags={tags}
  templateClass="tmpl-post"
  lang={lang}
>
  {showTranslationNotice && (
    <div class="translation-notice">
      {t('post.translation-notice')}
    </div>
  )}

  <h1>{title}</h1>

  <time class="postlist-date" datetime={formatDateISO(date)}>
    {formatDate(date)}
  </time>

  <div class="post-tag__container">
    {tags.map((tag) => (
      <a href={`${tagsBasePath}${tag.toLowerCase().replace(/\s+/g, '-')}/`} class="post-tag">
        #{tag}
      </a>
    ))}
  </div>

  <section class="content-section">
    <slot />
  </section>

  {(nextPost || previousPost) && (
    <>
      <hr class="content-rule-footer" />

      <div class="content-sources">
        <h3>ðŸ“– {t('post.sources')}</h3>
        <p>{t('post.sources.description')}</p>
      </div>

      <ul>
        {nextPost && (
          <li class="previous-next-page-link">
            {t('post.next')}: <a href={`${blogBasePath}${nextPost.slug.replace(/^(en|fr)\//, '')}/`}>{nextPost.data.title}</a>
          </li>
        )}
        {previousPost && (
          <li class="previous-next-page-link">
            {t('post.previous')}: <a href={`${blogBasePath}${previousPost.slug.replace(/^(en|fr)\//, '')}/`}>{previousPost.data.title}</a>
          </li>
        )}
      </ul>
    </>
  )}
</BaseLayout>
